Prompt:
How can I make sure my Apache Beam pipeline uses the latest version of the ML model?
Response:
Production ML Workflow often involves updating the AI model with new data. You can use the `RunInference` API to make sure your Apache Beam pipeline uses the latest version of the ML model. This is achieved by using the [Side input](https://beam.apache.org/documentation/programming-guide/#side-inputs) concept of Apache Beam, which allows you to pass additional data to a `DoFn` that is not part of the main input.

`RunInference` transform accepts optional input parameter `model_metadata_pcoll` side input `PCollection` of `ModelMetadata`  which is a `NamedTuple` containing `model_id` and `model_name` used to load model for inference and identify the model in the metric generated by the `RunInference` transform. The URL or path to the model should be compatible with the respective [ModelHandler requirements](https://beam.apache.org/documentation/ml/about-ml/#use-custom-models).

If the main collection emits inputs before the `model_metadata_pcoll` side input is emitted, the main PCollection will be buffered until the `model_metadata_pcoll` side input is available.

For more information on `ModelMetadata`, see [here](https://beam.apache.org/releases/pydoc/current/apache_beam.ml.inference.base.html#apache_beam.ml.inference.base.ModelMetadata).

Common approach to model update in production is to use a `FileWatchPattern` as side input.

```python
import apache_beam as beam
from apache_beam.ml.inference.utils import WatchFilePattern
from apache_beam.ml.inference.base import RunInference

tf_model_handler = ... # model handler for the model

with beam.Pipeline() as pipeline:

  file_pattern = '<path_to_model_file>'

  side_input_pcoll = (
    pipeline
    | "FilePatternUpdates" >> WatchFilePattern(file_pattern=file_pattern))

  main_input_pcoll = ... # main input PCollection

  inference_pcoll = (
    main_input_pcoll
    | "RunInference" >> RunInference(
    model_handler=model_handler,
    model_metadata_pcoll=side_input_pcoll))
```
In the example above, `model_metadata_pcoll` expects a `PCollection` of `ModelMetadata` compatible with `AsSingleton`. Because the pipeline uses `WatchFilePattern` as side input, it will take care of windowing and wrapping the output into `ModelMetadata`.

For more information see [here](https://beam.apache.org/documentation/ml/side-input-updates/).

