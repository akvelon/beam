# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

steps:
  - name: ubuntu
    args:
      - '-c'
      - >-
        apt update > /dev/null

        apt-get install -y wget unzip software-properties-common git curl
        apt-transport-https ca-certificates gnupg jq > /dev/null

        echo "deb https://packages.cloud.google.com/apt cloud-sdk main" | tee -a
        /etc/apt/sources.list.d/google-cloud-sdk.list

        curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add
        -

        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -

        add-apt-repository "deb [arch=amd64]
        https://download.docker.com/linux/ubuntu focal stable" > /dev/null

        apt install -y docker-ce > /dev/null

        wget
        https://releases.hashicorp.com/terraform/1.4.2/terraform_1.4.2_linux_amd64.zip 

        unzip terraform_1.4.2_linux_amd64.zip

        mv terraform /usr/local/bin/terraform

        terraform --version

        apt update -y > /dev/null && apt install -y google-cloud-sdk
        openjdk-11-jdk > /dev/null 

        git clone --branch merged_pg_gke_deployment
        https://github.com/akvelon/beam.git

        curl -fsSLo get_helm.sh
        https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 >
        /dev/null

        chmod +x get_helm.sh && ./get_helm.sh > /dev/null

        apt-get install google-cloud-sdk-gke-gcloud-auth-plugin

        cd beam

        mkdir playground/terraform/environment/$_ENVIRONMENT_NAME

        printf '%s\n' 'project_id = "$PROJECT_ID"' 'network_name =
        "$_NETWORK_NAME"' 'subnetwork_name = "$_SUBNETWORK_NAME"' 'gke_name =
        "$_GKE_NAME"' 'region = "$_PLAYGROUND_REGION"' 'zone =
        "$_PLAYGROUND_ZONE"' 'state_bucket = "$_STATE_BUCKET"' 'redis_name =
        "$_REDIS_NAME"' 'redis_tier = "$_REDIS_TIER"' 'min_count =
        "$_MIN_COUNT"' 'max_count = "$_MAX_COUNT"' 'app_engine_flag =
        "$_APPENGINE_FLAG"'         'ip-address-name = "$_IPADDRESS_NAME"'
        'repository_id = "$_REPOSITORY_ID"' 'service_account_id =
        "$_SERVICEACCOUNT_ID"' 'gke_machine_type = "$_GKE_MACHINETYPE"' >
        playground/terraform/environment/$_ENVIRONMENT_NAME/terraform.tfvars

        cat playground/terraform/environment/$_ENVIRONMENT_NAME/terraform.tfvars

        cat playground/terraform/environment/$_ENVIRONMENT_NAME/state.tfbackend

        gcloud auth configure-docker $_PLAYGROUND_REGION-docker.pkg.dev

        gcloud container clusters get-credentials --region $_PLAYGROUND_ZONE
        $_GKE_NAME --project $PROJECT_ID

        ./gradlew playground:terraform:gkebackend -Pproject_environment=myenv
        -Pdocker-tag=$_TAG_NAME -Pdns-name=$_DNS_NAME -Psdk-tag=$_SDK_TAG
        -Pdocker-repository-root=$_ARTIFACT_REGISTRY_NAME
        -Pdatastore-namespace=$_DATASTORE_NAMESPACE

        cat playground/infrastructure/helm-playground/values.yaml
    entrypoint: bash
timeout: 7200s
logsBucket: 'gs://$_PLAYGROUND_TFSTATE_BUCKET'
options:
  machineType: E2_HIGHCPU_32
  logging: GCS_ONLY
substitutions:
  _PLAYGROUND_TFSTATE_BUCKET: tfstate-pg-ruslan1
