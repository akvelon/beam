# Licensed to the Apache Software Foundation (ASF) under one or more
 # contributor license agreements.  See the NOTICE file distributed with
 # this work for additional information regarding copyright ownership.
 # The ASF licenses this file to You under the Apache License, Version 2.0
 # (the "License"); you may not use this file except in compliance with
 # the License.  You may obtain a copy of the License at
 #
 #     http://www.apache.org/licenses/LICENSE-2.0
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.

steps:
  - name: ubuntu
    args:
      - '-c'
      - |-
        echo "Search for CDLOG keyword to find valuable logs entries"
        echo "CDLOG $(date --utc '+%D %T') Trigger run inputs: 
         PR URL: $_PR_URL; 
         PR Source Repo: $_FORK_REPO; 
         PR Branch: $_PR_BRANCH;
         PR Commit: $_PR_COMMIT; 
         WebHook Action: $_PR_TYPE; 
         Merged to: $_TARGET_PR_REPO_BRANCH; 
         Playground DNS: $_DNS_NAME; "
        if [[ ${_TARGET_PR_REPO_BRANCH} != "apache:master" ]]; then
            echo "CDLOG Merge to branch apache/${_TARGET_PR_REPO_BRANCH}. Exiting"
            exit 0
        fi
        
        if [[ ${_PR_TYPE} == "closed" ]]; then

            echo "CDLOG Pull Request $_PR_URL has been successfully closed merged into Apache/Beam master repository. Continuing the process."
              
            echo "CDLOG Continous Deployment of Playground Examples (CD) in the progress."
  
            apt update > /dev/null 2>&1
  
            apt install -y git curl > /dev/null 2>&1
  
            apt-get install -y apt-transport-https ca-certificates gnupg > /dev/null 2>&1
  
            echo "deb https://packages.cloud.google.com/apt cloud-sdk main" > /dev/null 2>&1 | tee -a
            /etc/apt/sources.list.d/google-cloud-sdk.list > /dev/null 2>&1
  
            curl https://packages.cloud.google.com/apt/doc/apt-key.gpg > /dev/null 2>&1 | apt-key add - > /dev/null 2>&1 
  
            apt-get update && apt-get install -y google-cloud-sdk > /dev/null 2>&1
  
            git clone --branch master https://github.com/apache/beam.git > /dev/null 2>&1
  
            cd beam
  
            git remote add forked https://github.com/${_FORK_REPO}.git > /dev/null 2>&1
  
            curl -O --output-dir /tmp https://raw.githubusercontent.com/akvelon/beam/master/playground/infrastructure/cloudbuild/examples_cd.sh
  
            chmod +x /tmp/examples_cd.sh
            
            env -i bash -c "/tmp/examples_cd.sh NAMESPACE='"'${_NAMESPACE}'"' PROJECT_ID='"'${PROJECT_ID}'"' DNS_NAME='"'${_DNS_NAME}'"' COMMIT='"'${_PR_COMMIT}'"' "
            cd_script_status=$?

            if [ $cd_script_status -eq 0 ]; then
                echo "CDLOG $(date --utc '+%D %T') Examples deployment has been successfully completed. Please check Playground DNS https://${_DNS_NAME}."
            else
                echo "CDLOG $(date --utc '+%D %T') Examples deployment has failed. Please check the Cloud Build logs."
            fi
        else
            echo "CDLOG $(date --utc '+%D %T') PR in $_PR_URL for the COMMIT $_PR_COMMIT is not in closed state or not merged into the Apache/Beam master repo."
        fi
    entrypoint: bash
    secretEnv:
      - PAT
timeout: 7200s
logsBucket: 'gs://playground-cloudbuild-logs-private'
options:
  machineType: E2_HIGHCPU_32
  logging: GCS_ONLY
substitutions:
  _PR_URL: $(body.pull_request._links.html.href)
  _MERGE_STATUS: $(body.pull_request.merged)
  _TARGET_PR_REPO_BRANCH: $(body.pull_request.base.label)
  _PR_BRANCH: $(body.pull_request.head.ref)
  _LOG_LOCATION: '/tmp/build-log-${_PR_NUMBER}-${_COMMIT_SHA}-${BUILD_ID}.txt'
  _FORK_REPO: $(body.pull_request.head.repo.full_name)
  _PR_TYPE: $(body.action)
  _PR_COMMIT: $(body.pull_request.head.sha)
  _PR_NUMBER: $(body.number)
availableSecrets:
  secretManager:
    - versionName: >-
        projects/${PROJECT_ID}/secrets/github_pat_playground_deployment/versions/latest
      env: PAT
